#!/bin/bash
# =========================================
# Aura Assistant โ ะขะตัั ะฟะพัะปะต ะผะตัะดะถะฐ
# =========================================

APP_DIR="/opt/aura-assistant"
VENV_DIR="$APP_DIR/venv"
LOG_MAIN="$APP_DIR/aura.log"
LOG_CODEX="$APP_DIR/codex_errors.log"
LOG_DB="$APP_DIR/db_debug.log"
DB_FILE="$APP_DIR/db.sqlite3"

echo "๐งฉ Aura Assistant โ ัะตัั ะฟะพัะปะต ะผะตัะดะถะฐ"
cd "$APP_DIR" || exit 1

# 1๏ธโฃ ะะพะดััะณะธะฒะฐะตะผ ะฟะพัะปะตะดะฝะธะต ะธะทะผะตะฝะตะฝะธั
echo "๐ ะะพะปััะฐั ะฟะพัะปะตะดะฝัั ะฒะตััะธั ะธะท GitHub..."
git fetch origin
git pull --rebase origin main || git pull origin main

# 2๏ธโฃ ะคะธะบัะธััะตะผ ะธ ะฟััะธะผ ะปะพะบะฐะปัะฝัะต ะธะทะผะตะฝะตะฝะธั
echo "โฌ๏ธ ะะตะปะฐั ะบะพะผะผะธั ะธ ะฟัั..."
git add .
git commit -m "Post-merge auto-commit โ $(date +%Y-%m-%d_%H-%M-%S)" || echo "โน๏ธ ะะตั ะธะทะผะตะฝะตะฝะธะน ะดะปั ะบะพะผะผะธัะฐ."
git push origin main || echo "โ๏ธ ะัั ะฝะต ะฒัะฟะพะปะฝะตะฝ (ะฒะพะทะผะพะถะฝะพ ะฝะตั ะฝะพะฒัั ะธะทะผะตะฝะตะฝะธะน)."

# 3๏ธโฃ ะัะพะฒะตััะตะผ ะธ ัะฑะธะฒะฐะตะผ ััะฐััะต ะฟัะพัะตััั
PIDS=$(pgrep -f "main.py")
if [ -n "$PIDS" ]; then
  echo "โ ะะฐะนะดะตะฝั ััะฐััะต ะฟัะพัะตััั: $PIDS"
  kill -9 $PIDS
  echo "โ ะกัะฐััะต ะฟัะพัะตััั ะทะฐะฒะตััะตะฝั."
else
  echo "โน๏ธ ะกัะฐััั ะฟัะพัะตััะพะฒ ะฝะต ะฝะฐะนะดะตะฝะพ."
fi

# 4๏ธโฃ ะัะธัะฐะตะผ ะฑะฐะทั ะธ ะปะพะณะธ
echo "๐งน ะัะธัะฐั ะฑะฐะทั ะธ ะปะพะณะธ..."
rm -f "$DB_FILE" "$LOG_MAIN" "$LOG_CODEX" "$LOG_DB"

# 5๏ธโฃ ะะบัะธะฒะธััะตะผ ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต
echo "๐งฌ ะะบัะธะฒะธััั ะฒะธัััะฐะปัะฝะพะต ะพะบััะถะตะฝะธะต..."
source "$VENV_DIR/bin/activate"

# 6๏ธโฃ ะะฝะธัะธะฐะปะธะทะธััะตะผ ะฝะพะฒัั ะฑะฐะทั
echo "๐ช ะกะพะทะดะฐั ะฝะพะฒัั ะฑะฐะทั ะดะฐะฝะฝัั..."
python3 db.py --init

# 7๏ธโฃ ะะฐะฟััะบะฐะตะผ ะฑะพัะฐ ะฒ ัะพะฝะต
echo "๐ ะะฐะฟััะบะฐั Aura Assistant ะดะปั ัะตััะฐ..."
nohup python3 main.py >> "$LOG_MAIN" 2>&1 &

sleep 3
echo "โจ ะะพั ะทะฐะฟััะตะฝ ะดะปั ัะตััะฐ!"
echo "๐ ะัะฝะพะฒะฝะพะน ะปะพะณ: tail -f $LOG_MAIN"
